{{ partial "header.html" . }}
{{ define "main" }}
<main style="max-width:720px;margin:4rem auto;padding:0 1rem;
             color:#ddd;font-family:'Inter','Segoe UI',sans-serif;">

  <h1 style="text-align:center;color:#7dcfff;font-weight:700;margin-bottom:1.5rem;">
    🔍 搜索 NovaEdge
  </h1>

  <div style="display:flex;justify-content:center;margin-bottom:2rem;">
    <input id="searchInput" 
           placeholder="输入关键词后回车..."
           style="flex:1;max-width:420px;padding:0.6rem 1rem;
                  border:none;border-radius:10px;background:#1a1a1a;
                  color:#fff;font-size:1rem;outline:none;
                  box-shadow:0 0 10px rgba(125,207,255,0.25);">
  </div>

  <div id="searchResults" style="display:flex;flex-direction:column;gap:1rem;"></div>
</main>

<script src="{{ "js/fuse.basic.min.js" | relURL }}"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const inputEl = document.getElementById("searchInput");
  const resultBox = document.getElementById("searchResults");
  if (!inputEl || !resultBox) return;

  let fuseInstance = null;

  fetch('{{ "index.json" | absURL }}')
    .then(r => r.json())
    .then(data => {
      fuseInstance = new Fuse(data, {
        keys: ["title", "summary", "content"],
        threshold: 0.35
      });

      // 自动从 URL 读取搜索词
      const params = new URLSearchParams(window.location.search);
      const preset = params.get("q");
      if (preset) {
        inputEl.value = preset;
        performSearch(preset);
      }

      inputEl.addEventListener("input", e => {
        const q = e.target.value.trim();
        performSearch(q);
      });
    })
    .catch(() => {
      resultBox.innerHTML = `<p style="text-align:center;color:#f55;">无法加载搜索索引 (index.json)</p>`;
    });

  function performSearch(q) {
    if (!fuseInstance) return;
    if (!q) {
      resultBox.innerHTML = `<p style="text-align:center;color:#888;">请输入关键词开始搜索</p>`;
      return;
    }
    const results = fuseInstance.search(q);
    if (results.length === 0) {
      resultBox.innerHTML = `<p style="text-align:center;color:#999;">没有匹配 "${q}" 的结果。</p>`;
      return;
    }
    resultBox.innerHTML = results.slice(0, 10).map(r => {
      const p = r.item;
      const brief = (p.summary || p.content || "").slice(0, 150);
      return `
        <a href="${p.permalink}"
           style="display:block;text-decoration:none;padding:1.2rem;
                  border-radius:12px;background:rgba(255,255,255,0.04);
                  border:1px solid rgba(255,255,255,0.08);
                  transition:all .25s ease;">
          <h3 style="margin:0 0 .4rem 0;color:#7dcfff;">${p.title}</h3>
          <p style="color:#aaa;font-size:.9rem;line-height:1.5;margin:0;">${brief}...</p>
        </a>`;
    }).join("");
  }
});
</script>
{{ end }}
